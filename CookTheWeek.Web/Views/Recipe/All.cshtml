@using CookTheWeek.Services.Data.Interfaces
@using CookTheWeek.Web.Infrastructure.Extensions
@inject IUserService UserService
@inject IFavouriteRecipeService FavouriteRecipeService
@model AllRecipesQueryModel
@{
    ViewBag.Title = "All Recipes";
    string userId = User.GetId();   
}

<h2 class="text-center">@ViewBag.Title</h2>
<hr />
<div class="container-xl" style="max-width: 1200px;">
    <div class="row">
        <form method="get" class="pb-4">
            <div class="row justify-content-between align-items-center">
                <div class="col-sm-3">
                    <div class="form-group">
                        <label asp-for="Category" class="form-label">Category</label>
                        <select asp-for="Category" class="form-control">
                            <option value="">All</option>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category">@category</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-sm-5">
                    <div class="form-group">
                        <label asp-for="SearchString" class="form-label">Search</label>
                        <input asp-for="SearchString" class="form-control" placeholder="..." />
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="form-group">
                        <label asp-for="RecipeSorting" class="form-label">Sort By</label>
                        <select asp-for="RecipeSorting" class="form-control">
                            @foreach (var option in Model.RecipeSortings)
                            {
                                <option value="@option.Key">@option.Value</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-sm-auto">
                    <div class="row align-items-end">
                        <div class="col-sm-6">
                            <div class="form-group mb-0">
                                <label asp-for="RecipesPerPage" class="form-label">Per Page</label>
                                <select asp-for="RecipesPerPage" class="form-control">
                                    <option value="8">8</option>
                                    <option value="12">12</option>
                                    <option value="16">16</option>
                                    <option value="20">20</option>
                                    <option value="24">24</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group mb-0 d-flex justify-content-end">
                                <button type="submit" value="Search" class="btn btn-success">Search</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="container pt-2">
            @if (!Model.Recipes.Any())
            {
                <h2 class="text-center">No recipes found by the given criteria!</h2>
            }
            else
            {
                <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
                    @foreach (var recipe in Model.Recipes)
                    {
                        <partial name="_RecipeCardPartial" model="recipe"/>
                    }
                </div>
            }
        </div>      
        @{
            int previousPage = Model.CurrentPage - 1;
            if (previousPage < 1)
            {
                previousPage = 1;
            }

            int maxPage = (int)Math.Ceiling((double)Model.TotalRecipes / Model.RecipesPerPage);
        }
        <!-- Pagination buttons -->
        <nav aria-label="Page navigation" class="fixed-bottom">
            <ul class="pagination justify-content-center g-1">
                <li class="page-item">
                    <a class="btn btn-success @(Model.CurrentPage == 1 ? "disabled" : string.Empty)"
                       asp-controller="Recipe"
                       asp-action="All"
                       asp-route-currentPage="@previousPage"
                       asp-route-category="@Model.Category"
                       asp-route-searchTerm="@Model.SearchString"
                       asp-route-sorting="@((int)Model.RecipeSorting)">&lt;&lt;</a>
                </li>
                @{
                    bool shouldNextPageBeDisabled = Model.CurrentPage == maxPage ||
                    !Model.Recipes.Any();
                }
                <li class="page-item">
                    <a class="btn btn-success
            @(shouldNextPageBeDisabled ? "disabled" : string.Empty)"
                       asp-controller="Recipe"
                       asp-action="All"
                       asp-route-currentPage="@(Model.CurrentPage + 1)"
                       asp-route-category="@Model.Category"
                       asp-route-searchTerm="@Model.SearchString"
                       asp-route-sorting="@((int)Model.RecipeSorting)">>></a>
                </li>
            </ul>
        </nav>
               
    </div>
</div>
@section Scripts {
    <script>
        // Like btn functionality
        function toggleFavourites(event, recipeId, userId) {
            event.preventDefault();
            var $button = $(event.currentTarget);
            let url = 'https://localhost:7279/api/favouriteRecipe/toggleFavourites';

            var data = {
                RecipeId: recipeId,
                UserId: userId
            }

            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    // Handle success response
                    $button.find('i').toggleClass('liked-icon not-liked-icon');
                    toastr.success("Your preference is saved!");
                },
                error: function (xhr, status, error) {
                    // Handle error
                    if (xhr.status === 400) {
                        // Handle 400 Bad Request error
                        toastr.error('Bad Request: Please check your input and try again.');
                    } else {
                        // Display generic error message
                        toastr.error('Your preference not saved:', error);
                    }
                }
            });
        }
    </script>
}





